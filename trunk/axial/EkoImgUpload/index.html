<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">
<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>AJAX File Upload - Web Developer Plus Demos</title>
    <script type="text/javascript" src="js/jquery-1.3.2.js" ></script>
    <script type="text/javascript" src="js/ajaxupload.js" ></script>
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <script type="text/javascript" >
        function debug(message){
            if (window.console && window.console.firebug){
                console.log(message);
            }
        }
        function basename(path) {
            return path.replace(/\\/g,'/').replace( /.*\//, '' );
        }

        $(function(){
            //var baseURL = '';
            var baseURL = 'http://axial.imetrical.com/EkoImgUpload/';
            function clear(){
                $('#files').html('');
            }
            function seed(data){
                var images = data.images;
                for (var i=0;i<images.length;i++){
                    addIMG(images[i]);
                }
            }
            function addIMG(file){
                var imgurl = baseURL+file;
                $('<li></li>').appendTo('#files').html('<img src="'+imgurl+'" alt="" /><br />'+basename(file)).addClass('success');
            }
            function addERR(file){
                $('<li></li>').appendTo('#files').text(file).addClass('error');
            }
            function getList(aURL){
                //aURL = aURL || 'imglist.php';
                aURL = aURL || baseURL+'imglist.php';
                aURL+='?'+new Date().getTime();
                alert('getting: '+aURL);
                $.ajax({
                    url: aURL, // url from name ??
                    //data: data,
                    dataType: 'jsonp', // html,xml,json,jsonp
                    jsonp:'jsonp',
                    async: true,
                    success: function(data) {
                        debug('success');
                        debug(data);
                        clear();
                        seed(data);
                    }
                });

            }
            getList();

            var btnUpload=$('#upload');
            var status=$('#status');
            new AjaxUpload(btnUpload, {
                action: baseURL+'upload-file.php',
                name: 'uploadfile',
                onSubmit: function(file, ext){
                    if (! (ext && /^(jpg|png|jpeg|gif)$/.test(ext))){
                        // extension is not allowed
                        status.text('Only JPG, PNG or GIF files are allowed');
                        return false;
                    }
                    status.text('Uploading...');
                },
                onComplete: function(file, response){
                    //On completion clear the status
                    status.text('');
                    //Add uploaded file to list
                    if(response==="success"){
                        addIMG('./uploads/'+file);
                    } else{
                        status.text('failed: '+response+' - '+file);
                        addERR(file);
                    }
                    getList();
                }
            });

        });
    </script>
</head>
<body>
    <div id="mainbody" >
        <h3>&raquo; AJAX File Upload Form Using jQuery</h3>
        <!-- Upload Button, use any id you wish-->
        <div id="upload" ><span>Upload File<span></div><span id="status" ></span>

        <ul id="files" ></ul>
    </div>

</body>