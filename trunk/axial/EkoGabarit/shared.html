<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <!-- include from google
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
        -->
        <link type="text/css" href="css/start/jquery-ui-1.7.2.custom.css" rel="stylesheet" />

        <script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
        <script type="text/javascript" src="js/jquery.json-2.2.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>
        <script type="text/javascript" src="js/jquery.timer.js"></script>
        <script type="text/javascript" src="js/sha1-min.js"></script>

        <script type="text/javascript" src="js/ckeditor/ckeditor.js"></script>
        <script type="text/javascript" src="js/ckeditor/adapters/jquery.js"></script>
        <link href="gabarit.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript">
            //<![CDATA[

            // scope so dialog can see us
            var currentEditingElt=null;
            var ckElt = null
            var dialogElt = null;

            var ekoSaveCallback = function(editor) {
                if(currentEditingElt){
                    //alert(editor.getData());
                    currentEditingElt.html(ckElt.val());
                    currentEditingElt.show();
                    dialogElt.hide();
                } else {
                    alert('no cirrent Elt');
                }
            };

            var htmlString;
            $(function() {

                ckElt = $('<textarea class="dlg_ckeditor" cols="80" id="editor1" name="editor1" rows="10">CONTENT</textarea>');

                // height 100% is hard to acheive...
                //var ck_editor_height='100%'; //500;
                //var dlg_height = 600;//ck_editor_height+dlg_height_padding;

                var ck_editor_height=300;
                var dlg_height_padding = 134; //depends on toolbar choices...
                var dlg_height = ck_editor_height+dlg_height_padding;
                dialogElt = $('<div style="position:absolute;">').append(ckElt);
                $('#editordiv').append(dialogElt);
                dialogElt.resizable().draggable();
                dialogElt.hide();
                //$('#topSpace').resizable().draggable();

                var ck_config = {
                    BSCtoolbar:'Basic',
                    toolbar: [
                        [ 'ekosave','NewPage','Preview' ,'-', 'Bold', 'Italic' ]
                    ],
                    extraPlugins:'ekosave',
                    ZZtoolbar: [
                        ['Bold', 'Italic', '-', 'NumberedList', 'BulletedList', '-', 'Link', 'Unlink'],
                        ['UIColor']
                    ],
                    resize_enabled : false,
                    height: ck_editor_height,
                    sharedSpaces :	{
                        ZZtop : 'topSpace'
                    }
                };

                // Initialize the editor.
                // Callback function can be passed and executed after full instance creation.
                var ckeditor = null;
                var ck_initCallback = function(){
                    ckeditor = ckElt.ckeditorGet();
                }
                $('.dlg_ckeditor').ckeditor(ck_initCallback,ck_config);

                // callbacks
                $('#setBtn').click(function(){
                    //$( '.jquery_ckeditor' ).val( 'my new content '+new Date() );
                    $.ajax({
                        url: 'gabarit1.html',
                        //data: data,
                        dataType: 'html', // html,xml,json,jsonp
                        async: false,
                        success: function(data) {
                            htmlString = data;
                            //ckElt.val( htmlString );
                            $( '#preview' ).html( htmlString );
                        }
                    });
                });

                //var currentEditingElt=null;

                /*var dlgCloseHandler = function(event, ui) {
                    //alert('editor is dirty: '+ckeditor.cjeckDirty());
                    currentEditingElt.html(ckElt.val());
                };
                dialogElt.bind('dialogclose', dlgCloseHandler);
                 */

                $('#injectBtn').click(function(){
                    $( '#preview' ).find('ekko-placeholder').each(function(index){
                        $(this).addClass("editable");
                        $(this).hover(  function () {
                            $(this).addClass("editablehover");
                        },
                        function () {
                            $(this).removeClass("editablehover");
                        });
                        $(this).dblclick(function(){
                            currentEditingElt = $(this);
                            var celtoff = currentEditingElt.offset();
                            //alert('pos: '+$.toJSON(celtoff)+' '+currentEditingElt.width()+'x'+currentEditingElt.height());

                            ckElt.val( currentEditingElt.html() );
                            //currentEditingElt.hide();
                            //dialogElt.insertAfter(currentEditingElt);
                            dialogElt.show();
                            var dialogEltOffset = dialogElt.offset()
                            var contentEltOffset = dialogElt.find('.cke_contents').offset();
                            var compensate = {
                                left : dialogEltOffset.left-contentEltOffset.left,
                                top: dialogEltOffset.top-contentEltOffset.top
                            };
                            dialogElt.animate({
                                'left':celtoff.left+compensate.left,
                                'top':celtoff.top+compensate.top
                            });
                            //dialogElt.offset({
                            //    'left':celtoff.left,
                            //    'top':celtoff.top
                            //});
                            //$('#topSpace').offset({top:100,left:100});
                            //$('#topSpace').animate({'left' : "+=50px"});

                        });
                    });
                });
                $('#replaceBtn').click(function(){
                    $( '#preview' ).find('ekko-placeholder').each(function(index){
                        var aType = $(this).attr('type');
                        var anId = $(this).attr('id');
                        var aName = $(this).attr('name');
                        $(this).text('['+aType+':'+anId+':'+aName+']');
                    });
                });


                $('#openBtn').click(function() {
                    dialogElt.dialog('open');
                });

                $('#setBtn').click();
                $('#injectBtn').click();
            });
            //]]>
        </script>

    </head>
    <body>
        <h1>
            Editeur avec Gabarit
        </h1>
        <div><a id="setBtn" href="#">Set some content</a></div>
        <div><a id="injectBtn"href="#">Inject Behaviour</a></div>
        <div><a id="replaceBtn"href="#">Replace tags</a></div>
        <div><a id="openBtn"href="#">Open Dialog</a></div>
        <!-- This <div> holds alert messages to be display in the sample page. -->
        <div id="alerts">
            <noscript>
                <p>
                    <strong>CKEditor requires JavaScript to run</strong>. In a browser with no JavaScript
                    support, like yours, you should still see the contents (HTML data) and you should
                    be able to edit it normally, without a rich editor interface.
                </p>
            </noscript>
        </div>
        <div id="previewWrapper">
            <div id="preview">Preview du Contenu</div>
        </div>
        <!--<div id="topSpace"></div>-->
        <div id="editordiv"></div>
    </body>
</html>
