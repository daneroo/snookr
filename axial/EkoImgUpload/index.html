<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">
<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>AJAX Image Upload</title>
    <script type="text/javascript" src="js/jquery-1.3.2.js" ></script>
    <script type="text/javascript" src="js/ajaxupload.js" ></script>
    <!-- Required for jQuery dialog demo-->
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css" type="text/css" media="all" />

    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <script type="text/javascript" >
        function debug(message){
            if (window.console && window.console.firebug){
                console.log(message);
            }
        }
        function basename(path) {
            return path.replace(/\\/g,'/').replace( /.*\//, '' );
        }

        $(function(){
            //var baseURL = '';
            var baseURL = 'http://axial.imetrical.com/EkoImgUpload/';
            function clear(){
                $('#files').html('');
            }
            function seed(data){
                var images = data.images;
                for (var i=0;i<images.length;i++){
                    addIMG(images[i]);
                }
            }
            function addIMG(file){
                var imgurl = baseURL+file;
                $('<li></li>').appendTo('#files')
                .html('<img src="'+imgurl+'" alt="'+basename(file)+'" /><br />')
                .addClass('success')
                .click(function(){
                    $('#selectedFile').text(file);
                    $('#selectedImage').attr('src', imgurl);
                    $('#dialog').dialog("close");
                });
            }
            function addERR(file){
                $('<li></li>').appendTo('#files').text(file).addClass('error');
            }
            function getList(aURL){
                //aURL = aURL || 'imglist.php';
                aURL = aURL || baseURL+'imglist.php';
                aURL+='?'+new Date().getTime();
                debug('getting: '+aURL);
                $.ajax({
                    url: aURL, // url from name ??
                    //data: data,
                    dataType: 'jsonp', // html,xml,json,jsonp
                    jsonp:'jsonp',
                    async: true,
                    success: function(data) {
                        debug('success');
                        debug(data);
                        clear();
                        seed(data);
                    }
                });

            }
            getList();

            var btnUpload=$('#upload');
            var status=$('#status');
            ajopts = {
                action: baseURL+'upload-file.php',
                name: 'uploadfile',
                onSubmit: function(file, ext){
                    if (! (ext && /^(jpg|png|jpeg|gif)$/.test(ext))){
                        // extension is not allowed
                        status.text('Only JPG, PNG or GIF files are allowed');
                        return false;
                    }
                    status.text('Uploading...');
                    // what is this diabling ?
                    this.disable();
                },
                onComplete: function(file, response){
                    //On completion clear the status
                    status.text('');
                    //Add uploaded file to list
                    if(response==="success"){
                        addIMG('./uploads/'+file);
                    } else{
                        status.text('failed: '+response+' - '+file);
                        addERR(file);
                    }
                    getList();
                    this.enable();
                }
            };
            new AjaxUpload(btnUpload, ajopts);

            /* example4 */
            $("#dialog").dialog({
                autoOpen: false,
                width: 600,
                height:400,
                modal: false,
                buttons: {
                    'Cancel': function() {
                        $(this).dialog('close');
                    }
                }
            });
            $('#selectedFile').click(function(){
                $("#dialog").dialog("open");
                return false;
            });


        });/*]]>*/</script>
</head>

<body>
    <!-- Example 4 -->
    <p>You can use Ajax Uploader with jQuery UI dialog</p>
    <p>Selected Image <span id="selectedFile" >No Image Selected (click to select)</span>
      <br />
      <img id="selectedImage" />
    </p>

    <div id="dialog" style="display:none;" title="Basic dialog with Upload button">
        <div id="text">
            <div id="upload" ><span>Upload Image</span></div><span id="status" ></span>
            <div id="listwrapper">
                <ul id="files" ></ul>
            </div>
        </div>
    </div>




</body>