<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery.json-2.2.js"></script>

        <script type="text/javascript">
            function debug(message){
                if (window.console && window.console.firebug){
                    console.log(message);
                } else if (window.console) {
                    console.log(message);
                }
            }

            var nextJsonInvocationId=456
            function invoke(endpointurl,methodName,params,callbackFunction){
                endpointurl = endpointurl || "service/proxyService.php";
                var async=false;
                if (callbackFunction){
                    async=true;
                }

                // JayRock's proxys use text/plain, we will use application/json
                //var requestContentType="text/plain; charset=utf-8";
                var requestContentType="application/json; charset=utf-8";
                var requestParamWrapper = {
                    id: nextJsonInvocationId++,
                    method: methodName,
                    params: params
                };
                // not sure if I have to encode myself !
                var dataToPost = $.toJSON(requestParamWrapper);
                var response;
                //debug("invoking: "+dataToPost);
                $.ajax({
                    type: 'POST',
                    async: async,
                    url: endpointurl,
                    dataType: 'json',
                    contentType: requestContentType,
                    data: dataToPost,
                    success: function(data, textStatus) {
                        response=data;
                        //debug("invoke success");
                        //debug(data);
                        if (callbackFunction) {
                            callbackFunction(response.result);
                        }
                    },
                    error:function(xhr, textStatus, errorThrown){
                        debug(errorThrown);
                    }
                });
                if (async) {
                    return requestParamWrapper.id;
                }
                return response.result;
            };

            function login(username,passwd){
                return invoke(null, "login", [username,passwd], null);
            }
            function getit(sessionCookie,username){
                return invoke(null, "getit", [sessionCookie,username], null);
            }
            $(function(){
                debug("Proxied connect!");

                var username='scottdesk';
                var passwd='';

                function doOne(name,cookie){
                    var data = getit(cookie,username);
                    debug(""+name+": "+$.toJSON(data));
                    //debug(data);
                }

                //doOne("stale", "firstenergystaging_sessionid=36a1ad6d8ff833d111f1a354501c2709");
                //doOne("bad","firstenergystaging_sessionid=abcdefghijklmnopqrstuvwxyz012345");
                //doOne("null",null);
                //doOne("empty","");

                var sessionCookie = login(username,passwd+"bad");
                debug("bad session: "+sessionCookie);
                var sessionCookie = login(username,passwd);
                debug("good session: "+sessionCookie);

                doOne("goodAndNew-1",sessionCookie);
                //doOne("goodAndNew-2",sessionCookie);
            });
        </script>

    </head>
    <body>
        <div>This test shows a proxied connection client: see <b>Same origin policy</b>.
        </div>
        <div>Login to <a target="_new" href="https://firstenergy-staging.getgreenbox.com/accounts/login/">https://firstenergy-staging.getgreenbox.com/accounts/login/</a></div>
        <div>to access <a target="_new" href="http://firstenergy-staging.getgreenbox.com/">http://firstenergy-staging.getgreenbox.com/</a></div>
    </body>
</html>
